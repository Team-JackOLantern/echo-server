<!DOCTYPE html>
<html>
<head>
    <title>ì‹¤ì‹œê°„ ìš•ì„¤ ê°ì§€ í´ë¼ì´ì–¸íŠ¸ (ì¸ì¦ í¬í•¨)</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .auth-section, .main-section { 
            border: 1px solid #ddd; 
            padding: 20px; 
            margin: 10px 0; 
            border-radius: 5px; 
        }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .authenticated { background-color: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 200px; }
        .disabled { opacity: 0.5; cursor: not-allowed; }
        #log { border: 1px solid #ccc; height: 250px; overflow-y: scroll; padding: 10px; background: #f9f9f9; }
        .controls { margin: 20px 0; }
        .hidden { display: none; }
        .user-info { background: #e8f5e8; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ ì‹¤ì‹œê°„ ìš•ì„¤ ê°ì§€ (ì¸ì¦ ì‹œìŠ¤í…œ)</h1>
        
        <!-- ì¸ì¦ ì„¹ì…˜ -->
        <div id="authSection" class="auth-section">
            <h2>ì‚¬ìš©ì ì¸ì¦</h2>
            <div id="authStatus" class="status disconnected">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</div>
            
            <div id="loginForm">
                <h3>ë¡œê·¸ì¸</h3>
                <input type="text" id="loginUsername" placeholder="ì‚¬ìš©ìëª…" />
                <input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" />
                <button onclick="login()">ë¡œê·¸ì¸</button>
                <button onclick="showRegisterForm()">íšŒì›ê°€ì…</button>
            </div>
            
            <div id="registerForm" class="hidden">
                <h3>íšŒì›ê°€ì…</h3>
                <input type="text" id="registerUsername" placeholder="ì‚¬ìš©ìëª…" />
                <input type="password" id="registerPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" />
                <button onclick="register()">ê°€ì…í•˜ê¸°</button>
                <button onclick="showLoginForm()">ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
            
            <div id="userInfo" class="user-info hidden">
                <strong>ë¡œê·¸ì¸ëœ ì‚¬ìš©ì:</strong> <span id="currentUser"></span>
                <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
        
        <!-- ë©”ì¸ ê¸°ëŠ¥ ì„¹ì…˜ -->
        <div id="mainSection" class="main-section hidden">
            <div id="wsStatus" class="status disconnected">WebSocket ì—°ê²° ëŠê¹€</div>
            
            <div class="controls">
                <button id="connectBtn" onclick="connect()">ì—°ê²°</button>
                <button id="disconnectBtn" onclick="disconnect()" class="disabled">ì—°ê²° ëŠê¸°</button>
                <button id="startRecordBtn" onclick="startRecording()" class="disabled">ë…¹ìŒ ì‹œì‘</button>
                <button id="stopRecordBtn" onclick="stopRecording()" class="disabled">ë…¹ìŒ ì¤‘ì§€</button>
            </div>
            
            <div class="controls">
                <label>ê°ì§€ ë ˆë²¨: </label>
                <button onclick="setSensitivity(1)">ê°• (1)</button>
                <button onclick="setSensitivity(2)">ì¤‘ (2)</button>
                <button onclick="setSensitivity(3)">ì•½ (3)</button>
                <span id="currentSensitivity">í˜„ì¬: 2</span>
            </div>
            
            <div>
                <h3>ì‹¤ì‹œê°„ ìŒì„±ì¸ì‹ ë° ê°ì§€ ê²°ê³¼</h3>
                <div id="currentText" style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px;">
                    <strong>ì¸ì‹ëœ í…ìŠ¤íŠ¸:</strong> <span id="recognizedText">ëŒ€ê¸° ì¤‘...</span>
                </div>
                <div id="log"></div>
                <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        let userToken = null;
        let ws = null;
        let audioContext = null;
        let isRecording = false;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'detection' ? 'red' : type === 'error' ? 'red' : 'black';
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showRegisterForm() {
            document.getElementById('loginForm').className = 'hidden';
            document.getElementById('registerForm').className = '';
        }

        function showLoginForm() {
            document.getElementById('registerForm').className = 'hidden';
            document.getElementById('loginForm').className = '';
        }

        async function register() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;

            if (!username || !password) {
                alert('ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch('http://localhost:8000/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`íšŒì›ê°€ì… ì„±ê³µ! ì‚¬ìš©ì ID: ${data.user_id}`);
                    showLoginForm();
                } else {
                    alert('íšŒì›ê°€ì… ì‹¤íŒ¨: ' + data.detail);
                }
            } catch (err) {
                alert('íšŒì›ê°€ì… ì˜¤ë¥˜: ' + err.message);
            }
        }

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                alert('ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch('http://localhost:8000/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    userToken = data.user_id;
                    document.getElementById('currentUser').textContent = username + ` (${data.user_id})`;
                    document.getElementById('authStatus').textContent = 'ì¸ì¦ ì™„ë£Œ';
                    document.getElementById('authStatus').className = 'status authenticated';
                    document.getElementById('loginForm').className = 'hidden';
                    document.getElementById('userInfo').className = 'user-info';
                    document.getElementById('mainSection').className = 'main-section';
                    
                    // í˜„ì¬ ê°ì§€ ë ˆë²¨ ê°€ì ¸ì˜¤ê¸°
                    getSensitivity();
                } else {
                    alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + data.detail);
                }
            } catch (err) {
                alert('ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + err.message);
            }
        }

        function logout() {
            userToken = null;
            document.getElementById('authStatus').textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤';
            document.getElementById('authStatus').className = 'status disconnected';
            document.getElementById('userInfo').className = 'user-info hidden';
            document.getElementById('mainSection').className = 'main-section hidden';
            document.getElementById('loginForm').className = '';
            
            // WebSocket ì—°ê²° ì¢…ë£Œ
            if (ws) {
                ws.close();
            }
            if (audioContext) {
                audioContext.close();
            }
        }

        function connect() {
            if (!userToken) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”');
                return;
            }
            
            if (ws) return;
            
            // í—¤ë”ì— user_id í¬í•¨í•˜ì—¬ WebSocket ì—°ê²°
            ws = new WebSocket(`ws://localhost:8000/ws`, [], {
                headers: {
                    'user-id': userToken
                }
            });
            
            // WebSocketì€ í—¤ë”ë¥¼ ì§ì ‘ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ URL íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬
            ws = new WebSocket(`ws://localhost:8000/ws?user_id=${userToken}`);
            
            ws.onopen = function() {
                document.getElementById('wsStatus').textContent = 'WebSocket ì—°ê²°ë¨';
                document.getElementById('wsStatus').className = 'status connected';
                document.getElementById('connectBtn').className = 'disabled';
                document.getElementById('disconnectBtn').className = '';
                document.getElementById('startRecordBtn').className = '';
                log('WebSocket ì—°ê²° ì„±ê³µ');
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.error) {
                    log('ì˜¤ë¥˜: ' + data.error, 'error');
                    return;
                }
                
                // ì¸ì‹ëœ í…ìŠ¤íŠ¸ í‘œì‹œ
                const recognizedTextElement = document.getElementById('recognizedText');
                if (data.text) {
                    recognizedTextElement.textContent = data.text;
                    recognizedTextElement.style.color = data.detected ? 'red' : 'green';
                } else if (data.message) {
                    recognizedTextElement.textContent = data.message;
                    recognizedTextElement.style.color = 'gray';
                }
                
                // ë¡œê·¸ í‘œì‹œ
                if (data.detected) {
                    log(`ğŸ”´ ìš•ì„¤ ê°ì§€! í…ìŠ¤íŠ¸: "${data.text}" | íŒ¨í„´: [${data.patterns ? data.patterns.join(', ') : data.pattern}] | ì‹ ë¢°ë„: ${data.confidence.toFixed(2)}`, 'detection');
                } else if (data.text) {
                    log(`ğŸŸ¢ ì •ìƒ í…ìŠ¤íŠ¸: "${data.text}"`);
                } else {
                    log(`â„¹ï¸ ${data.message || 'ìŒì„± í™œë™ ì—†ìŒ'}`);
                }
            };
            
            ws.onclose = function() {
                document.getElementById('wsStatus').textContent = 'WebSocket ì—°ê²° ëŠê¹€';
                document.getElementById('wsStatus').className = 'status disconnected';
                document.getElementById('connectBtn').className = '';
                document.getElementById('disconnectBtn').className = 'disabled';
                document.getElementById('startRecordBtn').className = 'disabled';
                document.getElementById('stopRecordBtn').className = 'disabled';
                log('WebSocket ì—°ê²° ëŠê¹€', 'error');
                ws = null;
                if (isRecording) {
                    stopRecording();
                }
            };
            
            ws.onerror = function(error) {
                log('WebSocket ì˜¤ë¥˜: ' + error, 'error');
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
            }
        }

        async function startRecording() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('ë¨¼ì € WebSocketì— ì—°ê²°í•˜ì„¸ìš”');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: false,
                        noiseSuppression: false
                    } 
                });
                
                audioContext = new AudioContext({ sampleRate: 16000 });
                const source = audioContext.createMediaStreamSource(stream);
                const processor = audioContext.createScriptProcessor(4096, 1, 1);
                
                processor.onaudioprocess = function(e) {
                    if (!ws || ws.readyState !== WebSocket.OPEN) return;
                    
                    const inputBuffer = e.inputBuffer.getChannelData(0);
                    const int16Buffer = new Int16Array(inputBuffer.length);
                    for (let i = 0; i < inputBuffer.length; i++) {
                        int16Buffer[i] = Math.max(-32768, Math.min(32767, inputBuffer[i] * 32768));
                    }
                    ws.send(int16Buffer.buffer);
                };
                
                source.connect(processor);
                processor.connect(audioContext.destination);
                
                isRecording = true;
                document.getElementById('startRecordBtn').className = 'disabled';
                document.getElementById('stopRecordBtn').className = '';
                log('ğŸ¤ ë…¹ìŒ ì‹œì‘ - ì‹¤ì‹œê°„ ì˜¤ë””ì˜¤ ì „ì†¡ ì¤‘');
                
            } catch (err) {
                log('ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜: ' + err.message, 'error');
            }
        }

        function stopRecording() {
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            isRecording = false;
            document.getElementById('startRecordBtn').className = '';
            document.getElementById('stopRecordBtn').className = 'disabled';
            log('ğŸ›‘ ë…¹ìŒ ì¤‘ì§€');
        }

        async function setSensitivity(level) {
            if (!userToken) return;
            
            try {
                const response = await fetch('http://localhost:8000/sensitivity', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'user-id': userToken
                    },
                    body: JSON.stringify({ sensitivity: level })
                });
                const data = await response.json();
                document.getElementById('currentSensitivity').textContent = `í˜„ì¬: ${level}`;
                log(`âš™ï¸ ê°ì§€ ë ˆë²¨ ë³€ê²½: ${level}`);
            } catch (err) {
                log('ê°ì§€ ë ˆë²¨ ë³€ê²½ ì˜¤ë¥˜: ' + err.message, 'error');
            }
        }

        async function getSensitivity() {
            if (!userToken) return;
            
            try {
                const response = await fetch('http://localhost:8000/sensitivity', {
                    headers: { 'user-id': userToken }
                });
                const data = await response.json();
                document.getElementById('currentSensitivity').textContent = `í˜„ì¬: ${data.sensitivity}`;
            } catch (err) {
                log('ê°ì§€ ë ˆë²¨ í™•ì¸ ì˜¤ë¥˜: ' + err.message, 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
    </script>
</body>
</html>