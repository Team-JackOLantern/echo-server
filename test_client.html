<!DOCTYPE html>
<html>
<head>
    <title>ì‹¤ì‹œê°„ ìš•ì„¤ ê°ì§€ í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .detection { background-color: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .disabled { opacity: 0.5; cursor: not-allowed; }
        #log { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; background: #f9f9f9; }
        .controls { margin: 20px 0; }
    </style>
</head>
<body>
    <h1>ğŸ¤ ì‹¤ì‹œê°„ ìš•ì„¤ ê°ì§€ í…ŒìŠ¤íŠ¸</h1>
    
    <div id="status" class="status disconnected">ì—°ê²° ëŠê¹€</div>
    
    <div class="controls">
        <button id="connectBtn" onclick="connect()">ì—°ê²°</button>
        <button id="disconnectBtn" onclick="disconnect()" class="disabled">ì—°ê²° ëŠê¸°</button>
        <button id="startRecordBtn" onclick="startRecording()" class="disabled">ë…¹ìŒ ì‹œì‘</button>
        <button id="stopRecordBtn" onclick="stopRecording()" class="disabled">ë…¹ìŒ ì¤‘ì§€</button>
    </div>
    
    <div class="controls">
        <label>ê°ì§€ ë ˆë²¨: </label>
        <button onclick="setSensitivity(1)">ê°• (1)</button>
        <button onclick="setSensitivity(2)">ì¤‘ (2)</button>
        <button onclick="setSensitivity(3)">ì•½ (3)</button>
        <span id="currentSensitivity">í˜„ì¬: 2</span>
    </div>
    
    <div>
        <h3>ì‹¤ì‹œê°„ ìŒì„±ì¸ì‹ ë° ê°ì§€ ê²°ê³¼</h3>
        <div id="currentText" style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px;">
            <strong>ì¸ì‹ëœ í…ìŠ¤íŠ¸:</strong> <span id="recognizedText">ëŒ€ê¸° ì¤‘...</span>
        </div>
        <div id="log"></div>
        <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>

    <script>
        let ws = null;
        let mediaRecorder = null;
        let audioContext = null;
        let isRecording = false;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'detection' ? 'red' : type === 'error' ? 'red' : 'black';
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function connect() {
            if (ws) return;
            
            ws = new WebSocket('ws://localhost:8000/ws');
            
            ws.onopen = function() {
                document.getElementById('status').textContent = 'ì—°ê²°ë¨';
                document.getElementById('status').className = 'status connected';
                document.getElementById('connectBtn').className = 'disabled';
                document.getElementById('disconnectBtn').className = '';
                document.getElementById('startRecordBtn').className = '';
                log('WebSocket ì—°ê²° ì„±ê³µ');
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                // ì¸ì‹ëœ í…ìŠ¤íŠ¸ í‘œì‹œ
                const recognizedTextElement = document.getElementById('recognizedText');
                if (data.text) {
                    recognizedTextElement.textContent = data.text;
                    recognizedTextElement.style.color = data.detected ? 'red' : 'green';
                } else if (data.message) {
                    recognizedTextElement.textContent = data.message;
                    recognizedTextElement.style.color = 'gray';
                }
                
                // ë¡œê·¸ í‘œì‹œ
                if (data.detected) {
                    log(`ğŸ”´ ìš•ì„¤ ê°ì§€! í…ìŠ¤íŠ¸: "${data.text}" | íŒ¨í„´: [${data.patterns ? data.patterns.join(', ') : data.pattern}] | ì‹ ë¢°ë„: ${data.confidence.toFixed(2)} | ì—ë„ˆì§€: ${data.energy.toFixed(3)}`, 'detection');
                } else if (data.text) {
                    log(`ğŸŸ¢ ì •ìƒ í…ìŠ¤íŠ¸: "${data.text}" | ì—ë„ˆì§€: ${data.energy.toFixed(3)}`);
                } else {
                    log(`â„¹ï¸ ${data.message || 'ìŒì„± í™œë™ ì—†ìŒ'} | ì—ë„ˆì§€: ${data.energy ? data.energy.toFixed(3) : '0.000'}`);
                }
            };
            
            ws.onclose = function() {
                document.getElementById('status').textContent = 'ì—°ê²° ëŠê¹€';
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('connectBtn').className = '';
                document.getElementById('disconnectBtn').className = 'disabled';
                document.getElementById('startRecordBtn').className = 'disabled';
                document.getElementById('stopRecordBtn').className = 'disabled';
                log('WebSocket ì—°ê²° ëŠê¹€', 'error');
                ws = null;
                if (isRecording) {
                    stopRecording();
                }
            };
            
            ws.onerror = function(error) {
                log('WebSocket ì˜¤ë¥˜: ' + error, 'error');
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
            }
        }

        async function startRecording() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('ë¨¼ì € WebSocketì— ì—°ê²°í•˜ì„¸ìš”');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: false,
                        noiseSuppression: false
                    } 
                });
                
                audioContext = new AudioContext({ sampleRate: 16000 });
                const source = audioContext.createMediaStreamSource(stream);
                const processor = audioContext.createScriptProcessor(4096, 1, 1);
                
                processor.onaudioprocess = function(e) {
                    if (!ws || ws.readyState !== WebSocket.OPEN) return;
                    
                    const inputBuffer = e.inputBuffer.getChannelData(0);
                    // Float32ë¥¼ Int16ìœ¼ë¡œ ë³€í™˜
                    const int16Buffer = new Int16Array(inputBuffer.length);
                    for (let i = 0; i < inputBuffer.length; i++) {
                        int16Buffer[i] = Math.max(-32768, Math.min(32767, inputBuffer[i] * 32768));
                    }
                    ws.send(int16Buffer.buffer);
                };
                
                source.connect(processor);
                processor.connect(audioContext.destination);
                
                isRecording = true;
                document.getElementById('startRecordBtn').className = 'disabled';
                document.getElementById('stopRecordBtn').className = '';
                log('ğŸ¤ ë…¹ìŒ ì‹œì‘ - ì‹¤ì‹œê°„ ì˜¤ë””ì˜¤ ì „ì†¡ ì¤‘');
                
            } catch (err) {
                log('ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜: ' + err.message, 'error');
            }
        }

        function stopRecording() {
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            isRecording = false;
            document.getElementById('startRecordBtn').className = '';
            document.getElementById('stopRecordBtn').className = 'disabled';
            log('ğŸ›‘ ë…¹ìŒ ì¤‘ì§€');
        }

        async function setSensitivity(level) {
            try {
                const response = await fetch('http://localhost:8000/sensitivity', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sensitivity: level })
                });
                const data = await response.json();
                document.getElementById('currentSensitivity').textContent = `í˜„ì¬: ${level}`;
                log(`âš™ï¸ ê°ì§€ ë ˆë²¨ ë³€ê²½: ${level}`);
            } catch (err) {
                log('ê°ì§€ ë ˆë²¨ ë³€ê²½ ì˜¤ë¥˜: ' + err.message, 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ê°ì§€ ë ˆë²¨ í™•ì¸
        window.onload = async function() {
            try {
                const response = await fetch('http://localhost:8000/sensitivity');
                const data = await response.json();
                document.getElementById('currentSensitivity').textContent = `í˜„ì¬: ${data.sensitivity}`;
            } catch (err) {
                log('ê°ì§€ ë ˆë²¨ í™•ì¸ ì˜¤ë¥˜: ' + err.message, 'error');
            }
        };
    </script>
</body>
</html>