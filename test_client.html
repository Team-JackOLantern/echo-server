<!DOCTYPE html>
<html>
<head>
    <title>실시간 욕설 감지 테스트 클라이언트</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .detection { background-color: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .disabled { opacity: 0.5; cursor: not-allowed; }
        #log { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; background: #f9f9f9; }
        .controls { margin: 20px 0; }
    </style>
</head>
<body>
    <h1>🎤 실시간 욕설 감지 테스트</h1>
    
    <div id="status" class="status disconnected">연결 끊김</div>
    
    <div class="controls">
        <button id="connectBtn" onclick="connect()">연결</button>
        <button id="disconnectBtn" onclick="disconnect()" class="disabled">연결 끊기</button>
        <button id="startRecordBtn" onclick="startRecording()" class="disabled">녹음 시작</button>
        <button id="stopRecordBtn" onclick="stopRecording()" class="disabled">녹음 중지</button>
    </div>
    
    <div class="controls">
        <label>감지 레벨: </label>
        <button onclick="setSensitivity(1)">강 (1)</button>
        <button onclick="setSensitivity(2)">중 (2)</button>
        <button onclick="setSensitivity(3)">약 (3)</button>
        <span id="currentSensitivity">현재: 2</span>
    </div>
    
    <div>
        <h3>실시간 음성인식 및 감지 결과</h3>
        <div id="currentText" style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px;">
            <strong>인식된 텍스트:</strong> <span id="recognizedText">대기 중...</span>
        </div>
        <div id="log"></div>
        <button onclick="clearLog()">로그 지우기</button>
    </div>

    <script>
        let ws = null;
        let mediaRecorder = null;
        let audioContext = null;
        let isRecording = false;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'detection' ? 'red' : type === 'error' ? 'red' : 'black';
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function connect() {
            if (ws) return;
            
            ws = new WebSocket('ws://localhost:8000/ws');
            
            ws.onopen = function() {
                document.getElementById('status').textContent = '연결됨';
                document.getElementById('status').className = 'status connected';
                document.getElementById('connectBtn').className = 'disabled';
                document.getElementById('disconnectBtn').className = '';
                document.getElementById('startRecordBtn').className = '';
                log('WebSocket 연결 성공');
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                // 인식된 텍스트 표시
                const recognizedTextElement = document.getElementById('recognizedText');
                if (data.text) {
                    recognizedTextElement.textContent = data.text;
                    recognizedTextElement.style.color = data.detected ? 'red' : 'green';
                } else if (data.message) {
                    recognizedTextElement.textContent = data.message;
                    recognizedTextElement.style.color = 'gray';
                }
                
                // 로그 표시
                if (data.detected) {
                    log(`🔴 욕설 감지! 텍스트: "${data.text}" | 패턴: [${data.patterns ? data.patterns.join(', ') : data.pattern}] | 신뢰도: ${data.confidence.toFixed(2)} | 에너지: ${data.energy.toFixed(3)}`, 'detection');
                } else if (data.text) {
                    log(`🟢 정상 텍스트: "${data.text}" | 에너지: ${data.energy.toFixed(3)}`);
                } else {
                    log(`ℹ️ ${data.message || '음성 활동 없음'} | 에너지: ${data.energy ? data.energy.toFixed(3) : '0.000'}`);
                }
            };
            
            ws.onclose = function() {
                document.getElementById('status').textContent = '연결 끊김';
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('connectBtn').className = '';
                document.getElementById('disconnectBtn').className = 'disabled';
                document.getElementById('startRecordBtn').className = 'disabled';
                document.getElementById('stopRecordBtn').className = 'disabled';
                log('WebSocket 연결 끊김', 'error');
                ws = null;
                if (isRecording) {
                    stopRecording();
                }
            };
            
            ws.onerror = function(error) {
                log('WebSocket 오류: ' + error, 'error');
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
            }
        }

        async function startRecording() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('먼저 WebSocket에 연결하세요');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: false,
                        noiseSuppression: false
                    } 
                });
                
                audioContext = new AudioContext({ sampleRate: 16000 });
                const source = audioContext.createMediaStreamSource(stream);
                const processor = audioContext.createScriptProcessor(4096, 1, 1);
                
                processor.onaudioprocess = function(e) {
                    if (!ws || ws.readyState !== WebSocket.OPEN) return;
                    
                    const inputBuffer = e.inputBuffer.getChannelData(0);
                    // Float32를 Int16으로 변환
                    const int16Buffer = new Int16Array(inputBuffer.length);
                    for (let i = 0; i < inputBuffer.length; i++) {
                        int16Buffer[i] = Math.max(-32768, Math.min(32767, inputBuffer[i] * 32768));
                    }
                    ws.send(int16Buffer.buffer);
                };
                
                source.connect(processor);
                processor.connect(audioContext.destination);
                
                isRecording = true;
                document.getElementById('startRecordBtn').className = 'disabled';
                document.getElementById('stopRecordBtn').className = '';
                log('🎤 녹음 시작 - 실시간 오디오 전송 중');
                
            } catch (err) {
                log('마이크 접근 오류: ' + err.message, 'error');
            }
        }

        function stopRecording() {
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            isRecording = false;
            document.getElementById('startRecordBtn').className = '';
            document.getElementById('stopRecordBtn').className = 'disabled';
            log('🛑 녹음 중지');
        }

        async function setSensitivity(level) {
            try {
                const response = await fetch('http://localhost:8000/sensitivity', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sensitivity: level })
                });
                const data = await response.json();
                document.getElementById('currentSensitivity').textContent = `현재: ${level}`;
                log(`⚙️ 감지 레벨 변경: ${level}`);
            } catch (err) {
                log('감지 레벨 변경 오류: ' + err.message, 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // 페이지 로드 시 현재 감지 레벨 확인
        window.onload = async function() {
            try {
                const response = await fetch('http://localhost:8000/sensitivity');
                const data = await response.json();
                document.getElementById('currentSensitivity').textContent = `현재: ${data.sensitivity}`;
            } catch (err) {
                log('감지 레벨 확인 오류: ' + err.message, 'error');
            }
        };
    </script>
</body>
</html>